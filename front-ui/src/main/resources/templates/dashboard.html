<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç - jBank</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<div class="container">
    <h1>jBank - –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>
    <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <strong th:text="${currentUser.username}">username</strong>!
        <a th:href="@{/logout}" class="logout-inline">–í—ã–π—Ç–∏</a>
    </p>

    <!-- –°–æ–æ–±—â–µ–Ω–∏—è –æ–± —É—Å–ø–µ—Ö–µ/–æ—à–∏–±–∫–∞—Ö -->
    <div th:if="${success}" class="success" th:text="${success}"></div>
    <div th:if="${error}" class="error" th:text="${error}"></div>

    <!-- –ë–ª–æ–∫ –≤–Ω–µ—Å–µ–Ω–∏—è –∏ —Å–Ω—è—Ç–∏—è –¥–µ–Ω–µ–≥ -->
    <div class="cash-operations">
        <h2>–í–Ω–µ—Å–µ–Ω–∏–µ –∏ —Å–Ω—è—Ç–∏–µ –¥–µ–Ω–µ–≥</h2>
        <form th:action="@{/cash/operation}" method="post">
            <div>
                <label for="cashAccountId">–°—á–µ—Ç:</label>
                <select id="cashAccountId" name="accountId" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—á–µ—Ç</option>
                    <option th:each="account : ${bankAccounts}"
                            th:value="${account.id}"
                            th:text="${account.currency + ' - ' + account.amount}">
                        RUB - 1000.00
                    </option>
                </select>
            </div>`````
            <div>
                <label for="amount">–°—É–º–º–∞:</label>
                <input type="number" id="amount" name="amount" step="0.01" min="0.01" required>
            </div>
            <div>
                <button type="submit" name="operation" value="deposit">–ü–æ–ª–æ–∂–∏—Ç—å</button>
                <button type="submit" name="operation" value="withdraw">–°–Ω—è—Ç—å</button>
            </div>
        </form>
    </div>

    <!-- –ë–ª–æ–∫ –ø–µ—Ä–µ–≤–æ–¥–∞ –º–µ–∂–¥—É —Å–≤–æ–∏–º–∏ —Å—á–µ—Ç–∞–º–∏ -->
    <div class="internal-transfer">
        <h2>–ü–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É —Å–≤–æ–∏–º–∏ —Å—á–µ—Ç–∞–º–∏</h2>
        <form th:action="@{/transfer/internal}" method="post">
            <div>
                <label for="fromAccountId">–°—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å:</label>
                <select id="fromAccountId" name="fromAccountId" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—á–µ—Ç</option>
                    <option th:each="account : ${bankAccounts}"
                            th:value="${account.id}"
                            th:text="${account.currency + ' (' + account.amount + ')'}">
                        RUB (1000.00)
                    </option>
                </select>
            </div>
            <div>
                <label for="toAccountId">–°—á–µ—Ç –ø–æ–ª—É—á–∞—Ç–µ–ª—å:</label>
                <select id="toAccountId" name="toAccountId" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—á–µ—Ç</option>
                    <option th:each="account : ${bankAccounts}"
                            th:value="${account.id}"
                            th:text="${account.currency}">
                        USD
                    </option>
                </select>
            </div>
            <div>
                <label for="internalAmount">–°—É–º–º–∞:</label>
                <input type="number" id="internalAmount" name="amount" step="0.01" min="0.01" required>
            </div>
            <div>
                <button type="submit">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏</button>
            </div>
        </form>
    </div>

    <!-- –ë–ª–æ–∫ –ø–µ—Ä–µ–≤–æ–¥–∞ –Ω–∞ —Å—á–µ—Ç –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <div class="external-transfer">
        <h2>–ü–µ—Ä–µ–≤–æ–¥ –¥—Ä—É–≥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</h2>
        <form th:action="@{/transfer/external}" method="post">
            <div>
                <label for="senderAccountId">–í–∞—à —Å—á–µ—Ç:</label>
                <select id="senderAccountId" name="senderAccountId" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—á–µ—Ç</option>
                    <option th:each="account : ${bankAccounts}"
                            th:value="${account.id}"
                            th:text="${account.currency + ' (' + account.amount + ')'}">
                        RUB (1000.00)
                    </option>
                </select>
            </div>
            <div>
                <label for="receiverUsername">–õ–æ–≥–∏–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è:</label>
                <input type="text" id="receiverUsername" name="receiverUsername" required>
                <button type="button" id="searchReceiver">–ù–∞–π—Ç–∏</button>
            </div>
            <div>
                <label for="receiverAccountId">–°—á–µ—Ç –ø–æ–ª—É—á–∞—Ç–µ–ª—è:</label>
                <select id="receiverAccountId" name="receiverAccountId" required disabled>
                    <option value="">–°–Ω–∞—á–∞–ª–∞ –Ω–∞–π–¥–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è</option>
                </select>
            </div>
            <div>
                <label for="externalAmount">–°—É–º–º–∞:</label>
                <input type="number" id="externalAmount" name="amount" step="0.01" min="0.01" required>
            </div>
            <div>
                <button type="submit">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏</button>
            </div>
        </form>
    </div>



    <!-- –ë–ª–æ–∫ –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç -->
    <div class="exchange-rates">
        <h2>–ö—É—Ä—Å—ã –≤–∞–ª—é—Ç –∫ —Ä—É–±–ª—é
            <button id="refreshRates" class="btn-refresh" title="–û–±–Ω–æ–≤–∏—Ç—å –∫—É—Ä—Å—ã">üîÑ</button>
            <span class="auto-refresh-indicator">üîÑ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: <span id="refreshTimer">30</span>—Å</span>
        </h2>

        <div th:if="${exchangeRatesError}" class="error" th:text="${exchangeRatesError}"></div>

        <div class="rates-container">
            <table th:if="${exchangeRates != null and !exchangeRates.empty}">
                <thead>
                <tr>
                    <th>–í–∞–ª—é—Ç–∞</th>
                    <th>–ö—É—Ä—Å (–∑–∞ 1 –µ–¥–∏–Ω–∏—Ü—É)</th>
                </tr>
                </thead>
                <tbody id="ratesTableBody">
                <tr th:each="rate : ${exchangeRates}">
                    <td class="currency-cell" th:text="${rate.currency}">USD</td>
                    <td class="rate-cell" th:text="${#numbers.formatDecimal(rate.rate, 1, 4) + ' RUB'}">75.5000 RUB</td>
                </tr>
                </tbody>
            </table>
            <div th:if="${exchangeRates == null or exchangeRates.empty}" class="no-rates">
                <p>–ö—É—Ä—Å—ã –≤–∞–ª—é—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã</p>
            </div>
        </div>

        <!-- –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤–∞–ª—é—Ç -->
        <div class="currency-calculator">
            <h3>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤ —Ä—É–±–ª–∏</h3>
            <form id="calculatorForm">
                <div class="calculator-row">
                    <div>
                        <label for="fromCurrency">–í–∞–ª—é—Ç–∞:</label>
                        <select id="fromCurrency" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–ª—é—Ç—É</option>
                            <option value="RUB">RUB - –†–æ—Å—Å–∏–π—Å–∫–∏–π —Ä—É–±–ª—å</option>
                            <option th:each="rate : ${exchangeRates}"
                                    th:value="${rate.currency}"
                                    th:text="${rate.currency}">USD
                            </option>
                        </select>
                    </div>
                    <div>
                        <label for="calculatorAmount">–°—É–º–º–∞:</label>
                        <input type="number" id="calculatorAmount" step="0.01" min="0.01" required>
                    </div>
                    <div>
                        <button type="button" id="calculateBtn">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
                    </div>
                </div>
                <div id="calculationResult" class="calculation-result"></div>
            </form>
        </div>
    </div>

    <!-- –°–∫—Ä—ã–≤–∞–µ–º—ã–π –±–ª–æ–∫ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∞–∫–∫–∞—É–Ω—Ç–∞ -->
    <div class="account-settings-toggle">
        <button id="toggleAccountSettings" class="btn-toggle">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
    </div>

    <div id="accountSettings" class="account-settings hidden">
        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞</h2>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
        <div class="user-info">
            <p><strong>–õ–æ–≥–∏–Ω:</strong> <span th:text="${currentUser.username}">username</span></p>
            <form th:action="@{/account/delete}" method="post" style="display: inline;">
                <button type="submit" class="btn-danger"
                        onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç?')">
                    –£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç
                </button>
            </form>
        </div>

        <!-- –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è -->
        <div class="password-change">
            <h3>–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</h3>
            <form th:action="@{/account/change-password}" method="post">
                <div>
                    <label for="newPassword">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="newPassword" name="newPassword" required>
                </div>
                <div>
                    <label for="confirmPassword">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" required>
                </div>
                <button type="submit">–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
            </form>
        </div>

        <!-- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è -->
        <div class="profile-edit">
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h3>
            <form th:action="@{/account/update-profile}" method="post" th:object="${userProfile}">
                <div>
                    <label for="firstname">–ò–º—è:</label>
                    <input type="text" id="firstname" name="firstname" th:value="${userProfile?.firstname}" required>
                </div>
                <div>
                    <label for="lastname">–§–∞–º–∏–ª–∏—è:</label>
                    <input type="text" id="lastname" name="lastname" th:value="${userProfile?.lastname}" required>
                </div>
                <div>
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" th:value="${userProfile?.email}" required>
                </div>
                <div>
                    <label for="birthDate">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</label>
                    <input type="date" id="birthDate" name="birthDate" th:value="${userProfile?.birthdate}" required>
                </div>
                <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            </form>
        </div>

        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç–∞–º–∏ -->
        <div class="bank-accounts">
            <h3>–ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Å—á–µ—Ç–∞</h3>

            <!-- –°–ø–∏—Å–æ–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å—á–µ—Ç–æ–≤ -->
            <div class="accounts-list">
                <table th:if="${bankAccounts != null and !bankAccounts.empty}">
                    <thead>
                    <tr>
                        <th>–í–∞–ª—é—Ç–∞</th>
                        <th>–ë–∞–ª–∞–Ω—Å</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="account : ${bankAccounts}">
                        <td th:text="${account.currency}">RUB</td>
                        <td th:text="${account.amount + ' ' + account.currency}">0.00 RUB</td>
                        <td>
                            <form th:action="@{/account/delete-bank-account}" method="post" style="display: inline;">
                                <input type="hidden" name="accountId" th:value="${account.id}">
                                <button type="submit" class="btn-danger"
                                        onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —Å—á–µ—Ç?')">
                                    –£–¥–∞–ª–∏—Ç—å
                                </button>
                            </form>
                        </td>
                    </tr>
                    </tbody>
                </table>
                <p th:if="${bankAccounts == null or bankAccounts.empty}">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö —Å—á–µ—Ç–æ–≤</p>
            </div>

            <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å—á–µ—Ç–∞ -->
            <div class="add-account">
                <h4>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å—á–µ—Ç</h4>
                <form th:action="@{/account/add-bank-account}" method="post">
                    <div>
                        <label for="currency">–í–∞–ª—é—Ç–∞:</label>
                        <select id="currency" name="currency" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–ª—é—Ç—É</option>
                            <option value="RUB">RUB - –†–æ—Å—Å–∏–π—Å–∫–∏–π —Ä—É–±–ª—å</option>
                            <option value="USD">USD - –î–æ–ª–ª–∞—Ä –°–®–ê</option>
                            <option value="EUR">EUR - –ï–≤—Ä–æ</option>
                            <option value="CNY">CNY - –ö–∏—Ç–∞–π—Å–∫–∏–π —é–∞–Ω—å</option>
                        </select>
                    </div>
                    <button type="submit">–°–æ–∑–¥–∞—Ç—å —Å—á–µ—Ç</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // –°–∫—Ä—ã—Ç—å/–ø–æ–∫–∞–∑–∞—Ç—å –±–ª–æ–∫ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∞–∫–∫–∞—É–Ω—Ç–∞
    document.getElementById('toggleAccountSettings').addEventListener('click', function () {
        const settings = document.getElementById('accountSettings');
        const button = this;

        if (settings.classList.contains('hidden')) {
            settings.classList.remove('hidden');
            button.textContent = '–°–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏';
        } else {
            settings.classList.add('hidden');
            button.textContent = '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞';
        }
    });

    // –ü–æ–∏—Å–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞
    document.getElementById('searchReceiver').addEventListener('click', function () {
        const username = document.getElementById('receiverUsername').value;
        const accountSelect = document.getElementById('receiverAccountId');

        if (!username.trim()) {
            alert('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è');
            return;
        }

        fetch(`/api/accounts/search-receiver/${username}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                }
                return response.json();
            })
            .then(accounts => {
                accountSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—á–µ—Ç</option>';
                accountSelect.disabled = false;

                if (accounts && accounts.length > 0) {
                    accounts.forEach(account => {
                        const option = document.createElement('option');
                        option.value = account.id;
                        option.textContent = `${account.currency} - ${account.amount}`;
                        accountSelect.appendChild(option);
                    });
                } else {
                    accountSelect.innerHTML = '<option value="">–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç —Å—á–µ—Ç–æ–≤</option>';
                    accountSelect.disabled = true;
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è:', error);
                accountSelect.innerHTML = '<option value="">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω</option>';
                accountSelect.disabled = true;
            });
    });

    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Å—á–µ—Ç–æ–≤ –≤ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º –ø–µ—Ä–µ–≤–æ–¥–µ
    document.getElementById('fromAccountId').addEventListener('change', function () {
        const fromAccount = this.value;
        const toAccountSelect = document.getElementById('toAccountId');
        const options = toAccountSelect.options;

        for (let i = 0; i < options.length; i++) {
            const option = options[i];
            if (option.value === fromAccount && fromAccount !== '') {
                option.disabled = true;
                option.textContent = option.textContent.replace(' (–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)', '') + ' (–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)';
            } else {
                option.disabled = false;
                option.textContent = option.textContent.replace(' (–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)', '');
            }
        }
    });

    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —Å—á–µ—Ç–æ–≤
    document.addEventListener('DOMContentLoaded', function () {
        const currencySelect = document.getElementById('currency');
        const existingCurrencies = [];

        // –°–æ–±–∏—Ä–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≤–∞–ª—é—Ç—ã
        const accountRows = document.querySelectorAll('.accounts-list tbody tr');
        accountRows.forEach(row => {
            const currencyCell = row.querySelector('td:first-child');
            if (currencyCell) {
                existingCurrencies.push(currencyCell.textContent.trim());
            }
        });

        // –û—Ç–∫–ª—é—á–∞–µ–º –æ–ø—Ü–∏–∏ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –≤–∞–ª—é—Ç
        currencySelect.addEventListener('focus', function () {
            const options = this.querySelectorAll('option');
            options.forEach(option => {
                if (existingCurrencies.includes(option.value)) {
                    option.disabled = true;
                    option.textContent = option.textContent + ' (—É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)';
                }
            });
        });
    });

    document.getElementById('refreshRates').addEventListener('click', function () {
        const button = this;
        button.innerHTML = '‚è≥';
        button.disabled = true;

        fetch('/api/exchange/rates')
            .then(response => response.json())
            .then(rates => {
                updateRatesTable(rates);
                button.innerHTML = 'üîÑ';
                button.disabled = false;
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫—É—Ä—Å–æ–≤:', error);
                button.innerHTML = '‚ùå';
                setTimeout(() => {
                    button.innerHTML = 'üîÑ';
                    button.disabled = false;
                }, 3000);
            });
    });

    document.getElementById('calculateBtn').addEventListener('click', function () {
        const fromCurrency = document.getElementById('fromCurrency').value;
        const amount = document.getElementById('amount').value;
        const resultDiv = document.getElementById('calculationResult');

        if (!fromCurrency || !amount) {
            resultDiv.innerHTML = '<p class="error">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è</p>';
            return;
        }

        if (fromCurrency === 'RUB') {
            resultDiv.innerHTML = `
                <div class="result-success">
                    <strong>${amount} RUB = ${amount} RUB</strong>
                    <small>–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è</small>
                </div>
            `;
            return;
        }

        fetch(`/api/exchange/calculate?baseCurrency=${fromCurrency}&targetCurrency=RUB&amount=${amount}`)
            .then(response => response.json())
            .then(data => {
                resultDiv.innerHTML = `
                    <div class="result-success">
                        <strong>${amount} ${fromCurrency} = ${data.result.toFixed(2)} RUB</strong>
                    </div>
                `;
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ:', error);
                resultDiv.innerHTML = '<p class="error">–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ</p>';
            });
    });

    function updateRatesTable(rates) {
        const tbody = document.getElementById('ratesTableBody');
        if (!tbody) return;

        tbody.innerHTML = '';

        // –§–∏–ª—å—Ç—Ä—É–µ–º —Ä—É–±–ª—å –∏ –≤ JavaScript —Ç–æ–∂–µ
        Object.entries(rates)
            .filter(([currency, rate]) => currency !== 'RUB')
            .forEach(([currency, rate]) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="currency-cell">${currency}</td>
                    <td class="rate-cell">${rate.toFixed(4)} RUB</td>
                `;
                tbody.appendChild(row);
            });
    }

    let autoRefreshInterval;
    let countdownInterval;
    let timeLeft = 30;

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—É—Ä—Å–æ–≤
    function refreshRates() {
        const button = document.getElementById('refreshRates');
        button.innerHTML = '‚è≥';
        button.disabled = true;

        fetch('/api/exchange/rates')
            .then(response => response.json())
            .then(rates => {
                updateRatesTable(rates);
                updateCurrencyOptions(rates);
                button.innerHTML = 'üîÑ';
                button.disabled = false;
                resetAutoRefreshTimer();
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫—É—Ä—Å–æ–≤:', error);
                button.innerHTML = '‚ùå';
                setTimeout(() => {
                    button.innerHTML = 'üîÑ';
                    button.disabled = false;
                    resetAutoRefreshTimer();
                }, 3000);
            });
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–ø—Ü–∏–π –≤–∞–ª—é—Ç –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–µ
    function updateCurrencyOptions(rates) {
        const fromCurrency = document.getElementById('fromCurrency');
        const currentValue = fromCurrency.value;

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º RUB –æ–ø—Ü–∏—é
        fromCurrency.innerHTML = `
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–ª—é—Ç—É</option>
            <option value="RUB">RUB - –†–æ—Å—Å–∏–π—Å–∫–∏–π —Ä—É–±–ª—å</option>
        `;

        // –î–æ–±–∞–≤–ª—è–µ–º –≤–∞–ª—é—Ç—ã –∏–∑ –∫—É—Ä—Å–æ–≤
        Object.keys(rates)
            .filter(currency => currency !== 'RUB')
            .forEach(currency => {
                const option = document.createElement('option');
                option.value = currency;
                option.textContent = currency;
                fromCurrency.appendChild(option);
            });

        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        if (currentValue) {
            fromCurrency.value = currentValue;
        }
    }

    // function startAutoRefresh() {
    //     timeLeft = 30;
    //
    //     countdownInterval = setInterval(() => {
    //         timeLeft--;
    //         document.getElementById('refreshTimer').textContent = timeLeft;
    //
    //         if (timeLeft <= 0) {
    //             refreshRates();
    //         }
    //     }, 1000);
    // }
    //
    // function resetAutoRefreshTimer() {
    //     if (countdownInterval) {
    //         clearInterval(countdownInterval);
    //     }
    //     startAutoRefresh();
    // }
    //
    // document.addEventListener('DOMContentLoaded', function () {
    //     startAutoRefresh();
    //
    // });

    document.getElementById('refreshRates').addEventListener('click', function () {
        refreshRates();
    });

    document.getElementById('calculateBtn').addEventListener('click', function () {
        const fromCurrency = document.getElementById('fromCurrency').value;
        const amount = document.getElementById('calculatorAmount').value;
        const resultDiv = document.getElementById('calculationResult');

        console.log('–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä:', {fromCurrency, amount});

        if (!fromCurrency || !amount) {
            resultDiv.innerHTML = '<p class="error">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è</p>';
            return;
        }

        if (fromCurrency === 'RUB') {
            resultDiv.innerHTML = `
                <div class="result-success">
                    <strong>${amount} RUB = ${amount} RUB</strong>
                    <small>–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è</small>
                </div>
            `;
            return;
        }

        fetch(`/api/exchange/calculate?baseCurrency=${fromCurrency}&targetCurrency=RUB&amount=${amount}`)
            .then(response => response.json())
            .then(data => {
                resultDiv.innerHTML = `
                    <div class="result-success">
                        <strong>${amount} ${fromCurrency} = ${data.result.toFixed(2)} RUB</strong>
                    </div>
                `;
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ:', error);
                resultDiv.innerHTML = '<p class="error">–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ</p>';
            });
    });

    function updateRatesTable(rates) {
        const tbody = document.getElementById('ratesTableBody');
        if (!tbody) return;

        tbody.innerHTML = '';

        Object.entries(rates)
            .filter(([currency, rate]) => currency !== 'RUB')
            .forEach(([currency, rate]) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="currency-cell">${currency}</td>
                    <td class="rate-cell">${rate.toFixed(4)} RUB</td>
                `;
                tbody.appendChild(row);
            });
    }

</script>
</body>
</html>